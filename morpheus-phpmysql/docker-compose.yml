# Para implantar a stack manualmente após a execução do script:
# 1. Exporte as variáveis de ambiente necessárias:
#
#    export PASS_MYSQL=$(sudo sed -n 's/.*"root_password" *: *"\([^"]*\)".*/\1/p' /etc/morpheus/morpheus-secrets.json)
#    export PMA_PORT=<porta_phpmyadmin>
#    export PMA_USER=<usuario_mysql>
#    export MYSQL_PORT=<porta_mysql>
#    export HOST_IP=<ip_do_host>
#    export ENABLE_HTTP_AUTH=<true_ou_false>
#
# 2. Execute o Docker Compose para iniciar a stack:
#
#    docker compose up -d
#
# IMPORTANTE: 
# - Nenhum software adicional é instalado no servidor
# - Autenticação HTTP é configurada usando openssl nativo
# - Todos os arquivos são montados como volumes no container

services:
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: morpheus-phpmyadmin
    restart: unless-stopped
    ports:
      - "${PMA_PORT}:80"
    environment:
      PMA_HOST: "${HOST_IP}"
      PMA_PORT: "${MYSQL_PORT}"
      PMA_USER: "${PMA_USER}"
      PMA_PASSWORD: "${PASS_MYSQL}"
      UPLOAD_LIMIT: 256M
      PMA_ABSOLUTE_URI: "http://${HOST_IP}:${PMA_PORT}/"
    volumes:
      - phpmyadmin_sessions:/sessions
      # Volumes condicionais para autenticação HTTP (somente se arquivos existirem)
      - type: bind
        source: ./.htpasswd
        target: /etc/apache2/.htpasswd
        read_only: true
        bind:
          create_host_path: false
      - type: bind
        source: ./apache-security.conf
        target: /etc/apache2/conf-enabled/apache-security.conf
        read_only: true
        bind:
          create_host_path: false

volumes:
  phpmyadmin_sessions:
